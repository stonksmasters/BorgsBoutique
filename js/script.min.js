document.addEventListener("DOMContentLoaded",(()=>{let e=[],t=JSON.parse(localStorage.getItem("cart"))||[],n=JSON.parse(localStorage.getItem("favorites"))||[],a=0;const i=6;sessionStorage.getItem("imageErrorShown");function o(e,t="success"){const n=document.createElement("div");n.className=`toast toast-${t}`,n.setAttribute("role","alert"),n.setAttribute("aria-live","assertive"),n.textContent=e,document.body.appendChild(n),setTimeout((()=>n.remove()),3e3)}function r(e,t){let n;return(...a)=>{clearTimeout(n),n=setTimeout((()=>e(...a)),t)}}async function s(t=3){try{const t=`?v=${Date.now()}`,n=await fetch(`/product.json${t}`);if(!n.ok)throw new Error(`HTTP error: ${n.status}`);return e=await n.json(),localStorage.setItem("products",JSON.stringify(e)),e}catch(e){return t>1?(await new Promise((e=>setTimeout(e,1e3))),s(t-1)):(o("Unable to load products. Please try again later.","error"),[])}}async function c(t="all"){const r=document.querySelector(".product-grid");if(!r)return void o("Product grid not found.","error");r.classList.add("loading");const s="all"===t?e:e.filter((e=>e.category.toLowerCase()===t.toLowerCase())),c=a*i,l=c+i,u=s.slice(c,l);if(0===a&&(r.innerHTML=""),0===u.length&&0===a)return r.innerHTML='<p class="empty-cart">No products found in this category.</p>',void r.classList.remove("loading");u.forEach((e=>{const t=document.createElement("div");t.className="product-card";const a=e.images?.[0]??"/images/placeholder.png";t.innerHTML=`\n        <span class="category-badge">${e.category}</span>\n        <button class="wishlist-btn ${n.some((t=>t.id===e.id))?"active":""}" data-id="${e.id}" aria-label="${n.some((t=>t.id===e.id))?"Remove":"Add"} ${e.name} to favorites">\n          <i class="${n.some((t=>t.id===e.id))?"fas":"far"} fa-heart"></i>\n        </button>\n        <img src="${a}" alt="${e.name}" width="200" height="200" loading="lazy" onerror="handleImageError(this, '${a}')" />\n        <div class="content">\n          <h3>${e.name}</h3>\n          <p>${e.description}</p>\n          <span class="price">$${e.price.toFixed(2)}</span>\n          <div class="button-container">\n            <button class="quick-view-btn" data-id="${e.id}" aria-label="Quick view ${e.name}">Quick View</button>\n            <button class="add-to-cart-btn" data-id="${e.id}" aria-label="Add ${e.name} to cart">Add to Cart</button>\n          </div>\n        </div>\n      `,r.appendChild(t)}));const p=document.getElementById("load-more-btn");p&&(p.style.display=l>=s.length?"none":"block"),r.classList.remove("loading"),r.querySelectorAll(".quick-view-btn").forEach((e=>{e.removeEventListener("click",d),e.addEventListener("click",(()=>d(e.dataset.id)))})),r.querySelectorAll(".add-to-cart-btn").forEach((e=>{e.removeEventListener("click",m),e.addEventListener("click",(()=>m(e.dataset.id)))})),r.querySelectorAll(".wishlist-btn").forEach((e=>{e.removeEventListener("click",v),e.addEventListener("click",(()=>v(e.dataset.id)))}))}function l(){const e=document.getElementById("favorites-grid");e?(e.innerHTML="",0!==n.length?(n.forEach((t=>{const n=document.createElement("div");n.className="product-card";const a=t.images?.[0]??"/images/placeholder.png";n.innerHTML=`\n        <span class="category-badge">${t.category}</span>\n        <button class="wishlist-btn active" data-id="${t.id}" aria-label="Remove ${t.name} from favorites">\n          <i class="fas fa-heart"></i>\n        </button>\n        <img src="${a}" alt="${t.name}" width="200" height="200" loading="lazy" onerror="handleImageError(this, '${a}')" />\n        <div class="content">\n          <h3>${t.name}</h3>\n          <span class="price">$${t.price.toFixed(2)}</span>\n          <div class="button-container">\n            <button class="quick-view-btn" data-id="${t.id}" aria-label="Quick view ${t.name}">Quick View</button>\n            <button class="add-to-cart-btn" data-id="${t.id}" aria-label="Add ${t.name} to cart">Add to Cart</button>\n          </div>\n        </div>\n      `,e.appendChild(n)})),e.querySelectorAll(".wishlist-btn").forEach((e=>{e.removeEventListener("click",v),e.addEventListener("click",(()=>v(e.dataset.id)))})),e.querySelectorAll(".quick-view-btn").forEach((e=>{e.removeEventListener("click",d),e.addEventListener("click",(()=>d(e.dataset.id)))})),e.querySelectorAll(".add-to-cart-btn").forEach((e=>{e.removeEventListener("click",m),e.addEventListener("click",(()=>m(e.dataset.id)))}))):e.innerHTML='<p class="empty-favorites">No favorites added yet.</p>'):o("Favorites grid not found.","error")}function d(t){const a=e.find((e=>e.id==t));if(!a)return void o("Product not available.","error");const i=document.getElementById("quick-view-modal"),r=i.querySelector("#modal-product-name"),s=i.querySelector("#modal-product-description"),c=i.querySelector("#modal-product-price"),l=i.querySelector(".carousel"),d=document.getElementById("customization-options"),p=document.getElementById("related-products-grid"),g=i.querySelector("#add-to-cart-btn"),y=i.querySelector("#save-for-later-btn");if(!(r&&s&&c&&l&&d&&p&&g&&y))return void o("Error displaying product details.","error");i.dataset.id=t,r.textContent=a.name||"Unknown Product",s.textContent=a.description||"No description available.",c.textContent=a.price?`$${a.price.toFixed(2)}`:"Price unavailable",l.innerHTML=`\n      <div class="carousel-inner">\n        ${a.images?.length>0?a.images.map(((e,t)=>`\n          <img src="${e}" alt="${a.name} view ${t+1}" class="carousel-item ${0===t?"active":""}" width="300" height="300" loading="lazy" onerror="handleImageError(this, '${e}')" />\n        `)).join(""):`<img src="/images/placeholder.png" alt="${a.name} view 1" class="carousel-item active" width="300" height="300" loading="lazy" />`}\n      </div>\n      <button class="carousel-prev" aria-label="Previous image">❮</button>\n      <button class="carousel-next" aria-label="Next image">❯</button>\n    `,d.innerHTML=a.customization?`\n      <label for="custom-input">${a.customization.label}</label>\n      <input type="${"image"===a.customization.type?"file":"text"}" id="custom-input" placeholder="${a.customization.label}" accept="${"image"===a.customization.type?"image/*":""}" aria-label="${a.customization.label}" data-type="${a.customization.type}">\n    `:"<p>No customization available.</p>",p.innerHTML=(a.relatedProducts||[]).map((t=>{const n=e.find((e=>e.id==t));return n?`\n        <div class="related-product">\n          <img src="${n.images?.[0]??"/images/placeholder.png"}" alt="${n.name}" width="100" height="100" loading="lazy" onerror="handleImageError(this, '${n.images?.[0]}')" />\n          <span>${n.name}</span>\n        </div>\n      `:""})).join(""),y.textContent=n.some((e=>e.id==t))?"Remove from Favorites":"Save for Later",y.dataset.id=t,i.style.display="block",i.querySelector(".modal-content").focus();l.querySelector(".carousel-inner");const f=l.querySelectorAll(".carousel-item");let h=0;function b(){requestAnimationFrame((()=>{f.forEach(((e,t)=>{e.classList.toggle("active",t===h)}))}))}l.querySelector(".carousel-prev").addEventListener("click",(()=>{h=h>0?h-1:f.length-1,b()})),l.querySelector(".carousel-next").addEventListener("click",(()=>{h=h<f.length-1?h+1:0,b()}));const $=g.cloneNode(!0);g.parentNode.replaceChild($,g),$.dataset.id=t,$.addEventListener("click",(()=>{m(t,!0),u()}));const E=y.cloneNode(!0);y.parentNode.replaceChild(E,y),E.dataset.id=t,E.addEventListener("click",(()=>{v(t),u()}))}function u(){const e=document.getElementById("quick-view-modal");e&&(e.style.display="none",document.querySelector("header").focus())}function m(n,a=!1){const i=e.find((e=>e.id==n));if(!i)return void o("Product not available.","error");let r=null;if(a&&i.customization){const e=document.getElementById("custom-input");if(e)if("image"===i.customization.type&&e.files?.[0])r={type:"image",fileName:e.files[0].name};else{if("text"!==i.customization.type||!e.value.trim())return void o("Please provide customization details.","error");r={type:"text",value:e.value.trim()}}}const s=t.find((e=>e.id==n&&JSON.stringify(e.customization)===JSON.stringify(r)));s?s.quantity++:t.push({id:n,quantity:1,customization:r}),y(),E(),o(`Added "${i.name}" to cart.`,"success")}function p(e,n){t=t.filter(((t,a)=>!(t.id==e&&a===n))),y(),h(),E(),o("Product removed from cart.","success")}function v(t){const a=e.find((e=>e.id==t));if(!a)return void o("Product not available.","error");const i=n.findIndex((e=>e.id===a.id));-1===i?(n.push({id:a.id,name:a.name,price:a.price,images:a.images,category:a.category}),o(`Added "${a.name}" to favorites.`,"success")):(n.splice(i,1),o(`Removed "${a.name}" from favorites.`,"info")),localStorage.setItem("favorites",JSON.stringify(n)),g(),l()}function g(){document.querySelectorAll(".wishlist-btn").forEach((t=>{const a=Number(t.dataset.id);t.classList.toggle("active",n.some((e=>e.id===a)));t.querySelector("i").className=n.some((e=>e.id===a))?"fas fa-heart":"far fa-heart",t.setAttribute("aria-label",`${n.some((e=>e.id===a))?"Remove":"Add"} ${e.find((e=>e.id===a))?.name||"product"} to favorites`)}));const t=document.querySelector("#save-for-later-btn");if(t){const e=Number(t.dataset.id);t.textContent=n.some((t=>t.id===e))?"Remove from Favorites":"Save for Later"}}function y(){localStorage.setItem("cart",JSON.stringify(t)),f()}function f(){const e=t.reduce(((e,t)=>e+t.quantity),0),n=document.getElementById("cart-count");n&&(n.textContent=e)}function h(){const n=document.getElementById("cart"),a=n?.querySelector(".cart-items");if(!a)return;if(a.innerHTML="",0===t.length)return void(a.innerHTML='<p class="empty-cart">Your cart is empty.</p>');t.forEach(((t,n)=>{const i=e.find((e=>e.id==t.id));if(!i)return;const o=document.createElement("div");o.className="cart-item";const r=i.images?.[0]??"/images/placeholder.png";o.innerHTML=`\n        <img src="${r}" alt="${i.name}" width="50" height="50" loading="lazy" onerror="handleImageError(this, '${r}')" />\n        <div class="cart-item-details">\n          <h3>${i.name}</h3>\n          ${t.customization?`\n            <p>Customization: ${"image"===t.customization.type?`Image (${t.customization.fileName})`:t.customization.value}</p>\n          `:""}\n          <p>Price: $${i.price.toFixed(2)}</p>\n          <p>Qty: <input type="number" value="${t.quantity}" min="1" data-id="${t.id}" data-custom-index="${n}" aria-label="Quantity for ${i.name}"></p>\n          <p>Subtotal: $${(i.price*t.quantity).toFixed(2)}</p>\n          <button class="remove-btn" data-id="${t.id}" data-custom-index="${n}" aria-label="Remove ${i.name} from cart">Remove</button>\n        </div>\n      `,a.appendChild(o)})),a.querySelectorAll('input[type="number"]').forEach((e=>{e.removeEventListener("change",b),e.addEventListener("change",b)})),a.querySelectorAll(".remove-btn").forEach((e=>{e.removeEventListener("click",$),e.addEventListener("click",$)}));const i=t.reduce(((t,n)=>{const a=e.find((e=>e.id==n.id));return t+(a?a.price*n.quantity:0)}),0),o=n.querySelector(".cart-total h3");o&&(o.textContent=`Total: $${i.toFixed(2)}`)}function b(e){const n=e.target.dataset.id,a=Number(e.target.dataset.customIndex),i=parseInt(e.target.value);if(i>0){const e=t.find(((e,t)=>e.id==n&&t===a));e&&(e.quantity=i,y(),h())}else p(n,a)}function $(){p(this.dataset.id,Number(this.dataset.customIndex))}function E(){const n=document.querySelector(".mini-cart-content");n&&(0!==t.length?n.innerHTML=t.map((t=>{const n=e.find((e=>e.id==t.id));if(!n)return"";const a=n.images?.[0]??"/images/placeholder.png";return`\n        <div class="mini-cart-item">\n          <img src="${a}" alt="${n.name}" width="30" height="30" loading="lazy" onerror="handleImageError(this, '${a}')" />\n          <span>${n.name} x ${t.quantity}${t.customization?` (${"image"===t.customization.type?"Image":t.customization.value})`:""}</span>\n          <span>$${(n.price*t.quantity).toFixed(2)}</span>\n        </div>\n      `})).join(""):n.innerHTML="<p>Your cart is empty.</p>")}function L(){const e=window.location.hash||"#home",t=document.querySelectorAll("section"),n=["faq","testimonials","newsletter"],a=document.getElementById("shop"),i=document.getElementById("favorites"),o=document.getElementById("home");if(t.forEach((e=>{e.style.display=n.includes(e.id)?"block":"none"})),"#home"===e)o&&(o.style.display="block"),S();else if("#favorites"===e)a&&i&&(a.style.display="block",l(),i.scrollIntoView({behavior:"smooth"}));else if("#shop"===e)a&&(a.style.display="block",c());else if("#cart"===e){const e=document.getElementById("cart");e&&(e.style.display="block",h(),e.scrollIntoView({behavior:"smooth"}))}else{const t=document.getElementById(e.substring(1));t&&(t.style.display="block",t.scrollIntoView({behavior:"smooth"}))}}async function S(){const e=document.querySelector(".testimonial-grid");if(!e)return;const t=await async function(){const e=localStorage.getItem("testimonials");if(e)return JSON.parse(e);try{const e=await fetch("/public/testimonials.json");if(!e.ok)throw new Error(`HTTP error: ${e.status}`);const t=await e.json();return localStorage.setItem("testimonials",JSON.stringify(t)),t}catch(e){o("Testimonials unavailable. Showing default.","info");const t=[{image:"/images/placeholder.png",quote:"Beautiful craftsmanship! Our custom lamp is a cherished keepsake.",name:"Jane Doe"}];return localStorage.setItem("testimonials",JSON.stringify(t)),t}}();0!==t.length?e.innerHTML=t.map((e=>`\n      <div class="testimonial">\n        <img src="${e.image||"/images/placeholder.png"}" alt="${e.name}" width="100" height="100" loading="lazy" onerror="handleImageError(this, '${e.image}')" />\n        <p>"${e.quote}"</p>\n        <h4>${e.name}</h4>\n      </div>\n    `)).join(""):e.innerHTML="<p>No testimonials available.</p>"}const q=document.querySelector(".nav-toggle"),k=document.querySelector(".nav-links");q&&k&&(q.addEventListener("click",(()=>{const e=k.classList.toggle("nav-open");q.classList.toggle("active"),q.setAttribute("aria-expanded",e)})),k.querySelectorAll("a").forEach((e=>{e.addEventListener("click",(()=>{k.classList.remove("nav-open"),q.classList.remove("active"),q.setAttribute("aria-expanded","false")}))})),document.addEventListener("click",(e=>{k.contains(e.target)||q.contains(e.target)||!k.classList.contains("nav-open")||(k.classList.remove("nav-open"),q.classList.remove("active"),q.setAttribute("aria-expanded","false"))}))),document.querySelectorAll(".occasion-btn").forEach((e=>{e.addEventListener("click",r((()=>{var t;document.querySelectorAll(".occasion-btn").forEach((e=>e.classList.remove("active"))),e.classList.add("active"),t=e.dataset.category,a=0,c(t)}),300))}));const w=document.getElementById("load-more-btn");w&&w.addEventListener("click",(()=>{a++,c(document.querySelector(".occasion-btn.active")?.dataset.category??"all")}));const I=document.querySelector(".cart-link"),A=document.querySelector(".mini-cart-dropdown");I&&A&&(I.addEventListener("mouseenter",(()=>{A.style.display="block"})),I.addEventListener("mouseleave",(()=>{A.style.display="none"}))),document.querySelectorAll(".faq-question").forEach((e=>{e.addEventListener("click",(()=>{const t=e.nextElementSibling,n="block"===t.style.display;t.style.display=n?"none":"block",e.setAttribute("aria-expanded",!n)}))})),document.querySelectorAll(".newsletter-form, .footer-newsletter form").forEach((e=>{e.addEventListener("submit",(t=>{t.preventDefault();const n=e.querySelector('input[type="email"]'),a=n.value.trim();/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a)?(o("Thank you for subscribing!","success"),n.value=""):o("Please enter a valid email address.","error")}))}));const x=document.getElementById("quick-view-modal");document.addEventListener("keydown",(e=>{"Escape"===e.key&&"block"===x?.style.display&&u()})),window.addEventListener("hashchange",r(L,100)),async function(){await s(),c(),l(),S(),f(),E(),g(),setTimeout(L,0),function(){const e=document.querySelectorAll(".hero, .shop, .testimonials, .favorites, .cart, .faq, .newsletter"),t=new IntersectionObserver((e=>{e.forEach((e=>{e.isIntersecting&&e.target.classList.add("visible")}))}),{threshold:.1});e.forEach((e=>t.observe(e)))}();const e=document.querySelector(".close-btn");e&&e.addEventListener("click",u)}()}));